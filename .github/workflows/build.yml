name: Build and Package

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  check-version:
    name: Check Version and Create Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      tag_exists: ${{ steps.check-tag.outputs.tag_exists }}
      should_release: ${{ steps.check-release.outputs.should_release }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get version from Cargo.toml
        id: get-version
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | head -n 1 | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Check if tag exists
        id: check-tag
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if git ls-remote --tags origin | grep -q "refs/tags/v$VERSION"; then
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if release exists
        id: check-release
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          RELEASE_EXISTS=$(curl -s -o /dev/null -w "%{http_code}" https://api.github.com/repos/${{ github.repository }}/releases/tags/v$VERSION)
          echo "should_release=true" >> $GITHUB_OUTPUT
          if [[ "$RELEASE_EXISTS" == "200" ]]; then
            RELEASE_ID=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/v$VERSION | jq -r .id)
            if [[ "$RELEASE_ID" != "null" ]]; then
              curl -s -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID
            fi
          fi

      - name: Create and push tag
        if: steps.check-tag.outputs.tag_exists == 'false'
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

  build:
    name: Build ${{ matrix.os }}
    needs: check-version
    if: ${{ needs.check-version.outputs.should_release == 'true' || startsWith(github.ref, 'refs/tags/') }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: Spray-windows-x86_64
            binary_path: target/x86_64-pc-windows-msvc/release/Spray.exe

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache LFS objects
        uses: actions/cache@v4
        with:
          path: .git/lfs
          key: ${{ runner.os }}-lfs-${{ hashFiles('.gitattributes') }}
          restore-keys: |
            ${{ runner.os }}-lfs-

      - name: Verify assets
        run: |
          echo "Checking assets..."
          git lfs ls-files

          if [ -f "assets/evernight.gif" ]; then
            echo "‚úÖ Found evernight.gif (embedded default)"
            GIF_SIZE=$(du -h assets/evernight.gif | cut -f1)
            echo "GIF size: $GIF_SIZE"
          else
            echo "‚ö†Ô∏è Warning: evernight.gif not found (will use embedded version from source)"
          fi

          if [ -d "assets/frames" ]; then
            FRAME_COUNT=$(ls -1 assets/frames/*.png 2>/dev/null | wc -l)
            echo "Found $FRAME_COUNT frame files (optional, for fallback)"
          else
            echo "‚ÑπÔ∏è assets/frames directory not found (optional, embedded GIF will be used)"
          fi
        shell: bash

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build binary
        run: cargo build --release --target ${{ matrix.target }}
        env:
          RUSTFLAGS: "-C target-cpu=x86-64 -C opt-level=3"

      - name: Test binary can execute
        run: |
          $binary = "${{ matrix.binary_path }}"
          if (Test-Path $binary) {
            Write-Host "Binary exists at: $binary"
            $fileInfo = Get-Item $binary
            Write-Host "File size: $($fileInfo.Length) bytes"
            Write-Host "Created: $($fileInfo.CreationTime)"
            
            # Try to get file version info
            try {
              $versionInfo = [System.Diagnostics.FileVersionInfo]::GetVersionInfo($binary)
              Write-Host "File version: $($versionInfo.FileVersion)"
              Write-Host "Product version: $($versionInfo.ProductVersion)"
            } catch {
              Write-Host "Could not get version info"
            }
            
            # Check if it's a valid PE file
            $header = [System.IO.File]::ReadAllBytes($binary)[0..1]
            if ($header[0] -eq 0x4D -and $header[1] -eq 0x5A) {
              Write-Host "‚úÖ Valid PE executable (MZ header found)"
            } else {
              Write-Host "‚ùå Invalid PE executable"
              exit 1
            }
          } else {
            Write-Host "‚ùå Binary not found"
            exit 1
          }
        shell: pwsh

      - name: Display binary size
        run: |
          if [ -f "${{ matrix.binary_path }}" ]; then
            ls -lh "${{ matrix.binary_path }}"
            echo "Binary size: $(du -h "${{ matrix.binary_path }}" | cut -f1)"
          else
            echo "Error: Binary not found at ${{ matrix.binary_path }}"
            exit 1
          fi
        shell: bash

      - name: Verify binary architecture
        run: |
          $binary = "${{ matrix.binary_path }}"
          Write-Host "Verifying binary architecture..."

          # Read PE header
          $bytes = [System.IO.File]::ReadAllBytes($binary)

          # Check if x64
          $peOffset = [BitConverter]::ToInt32($bytes, 0x3C)
          $machine = [BitConverter]::ToUInt16($bytes, $peOffset + 4)

          if ($machine -eq 0x8664) {
            Write-Host "‚úÖ Binary is x64 (AMD64)"
          } elseif ($machine -eq 0x014C) {
            Write-Host "‚ö†Ô∏è Binary is x86 (i386)"
          } else {
            Write-Host "‚ùì Unknown architecture: 0x$($machine.ToString('X4'))"
          }

          Write-Host "`nBinary info:"
          Write-Host "- Size: $([Math]::Round($bytes.Length / 1MB, 2)) MB"
          Write-Host "- Path: $binary"
        shell: pwsh

      - name: Upload release binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.binary_path }}

  release:
    name: Create Release
    needs: [check-version, build]
    if: ${{ needs.check-version.outputs.should_release == 'true' || startsWith(github.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit info
        id: commit-info
        run: |
          if [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then
            TAG_COMMIT=$(git rev-list -n 1 ${{ github.ref_name }})
            COMMIT_MSG=$(git log -1 --pretty=%s $TAG_COMMIT)
            COMMIT_DESC=$(git log -1 --pretty=%b $TAG_COMMIT)
          else
            COMMIT_MSG=$(git log -1 --pretty=%s)
            COMMIT_DESC=$(git log -1 --pretty=%b)
          fi

          echo "message_raw<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "description_raw<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_DESC" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Prepare release files
        run: |
          ls -la Spray-windows-x86_64/
        shell: bash

      - name: Create release package
        run: |
          mkdir -p release-package
          cp Spray-windows-x86_64/Spray.exe release-package/
          cp README.md release-package/
          cp CUSTOM_FRAMES.md release-package/

          # Create example config
          cat > release-package/spray.config.json << 'EOF'
          {
            "fps": 12,
            "auto_startup": false,
            "frame_digits": 4,
            "frame_width": 200.0,
            "frame_height": 250.0,
            "window_title": "Spray",
            "frame_folder": "frames",
            "gif_path": "evernight.gif",
            "mode": "auto",
            "scale_percent": 40.0
          }
          EOF

          # Create quick start guide
          cat > release-package/QUICKSTART.txt << 'EOF'
          Spray Desktop Pet - Quick Start Guide
          =====================================

          1. Run Spray.exe - the app will appear above your taskbar
          2. Drag it anywhere on screen
          3. Edit spray.config.json to customize (auto-created on first run)

          For custom animations:
          - Place GIF file: assets/evernight.gif (or any .gif, set gif_path in config)
          - Or create folder: assets/frames/ with PNG frames: frame_0001.png, frame_0002.png, etc.
          - See CUSTOM_FRAMES.md for details

          Requirements:
          - Windows 10/11
          - No additional runtime needed

          If app doesn't start:
          - Check Windows Defender/Antivirus
          - Try running as administrator

          More info: https://github.com/mewisme/spray
          EOF

          ls -la release-package/
        shell: bash

      - name: Prepare release notes
        id: release-notes
        run: |
          cat > release-notes.md << 'EOF'
          ${{ steps.commit-info.outputs.description_raw }}

          ---

          ## üì¶ Files Included

          - **Spray.exe** - Main executable (release build, optimized)
          - **spray.config.json** - Example configuration file
          - **README.md** - Full documentation
          - **CUSTOM_FRAMES.md** - Guide for custom animations
          - **QUICKSTART.txt** - Quick start guide

          ## üöÄ Quick Start

          1. Download `Spray.exe`
          2. Run it - the app will appear above your taskbar with embedded animation
          3. Drag to move, edit `spray.config.json` to customize
          4. Edit config to change FPS, window size, scale, etc.

          ## ‚ö†Ô∏è Troubleshooting

          **If app doesn't start:**
          1. Check Windows Defender - it may block the executable
          2. Right-click ‚Üí Properties ‚Üí Unblock
          3. Try running as administrator

          **Requirements:**
          - Windows 10/11 (64-bit)
          - DirectX 11 compatible GPU
          - 100MB RAM
          - 100MB disk space
          - Windows 11 recommended
          - Dedicated GPU recommended
          - 200MB RAM recommended
          - No additional runtime needed

          ## üîó Links

          - [Full Documentation](README.md)
          - [Custom Frames Guide](CUSTOM_FRAMES.md)
          - [Report Issues](https://github.com/${{ github.repository }}/issues)
          EOF

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Spray-windows-x86_64/Spray.exe
            release-package/spray.config.json
            release-package/README.md
            release-package/CUSTOM_FRAMES.md
            release-package/QUICKSTART.txt
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', needs.check-version.outputs.version) }}
          name: ${{ steps.commit-info.outputs.message_raw }}
          body: ${{ steps.release-notes.outputs.notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
